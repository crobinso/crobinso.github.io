<!DOCTYPE html>
<html>
    <head>
        <title>virt-manager 1.0 creates qcow2 images that don't work on RHEL6 - Cole's dev log</title>
        <meta charset="utf-8" />
        <link href="https://blog2.wikichoon.com/theme/minima-main.css" rel="stylesheet" />
        <link href="https://blog2.wikichoon.com/theme/coletheme.css" rel="stylesheet" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <link href="https://blog2.wikichoon.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Cole's dev log Full Atom Feed" />
    </head>

    <body id="index" class="archive">
        <div class="wrapper">
            <header class="site-header" role="banner">
                <a class="site-title" href="https://blog2.wikichoon.com">Cole's dev log</a>
                <nav class="site-nav">
                <div class="trigger">
                    <a class="page-link" href="https://blog2.wikichoon.com">Home</a>
                    <a class="page-link" href="https://blog2.wikichoon.com/archives.html">Archives</a>
                <!-- -->
                </div></nav>
             </header>
<main id="content" class="page-content">

  <header>
    <h2 class="post-title">virt-manager 1.0 creates qcow2 images that don't work on RHEL6</h2>
    <p class="post-meta">
      <time class="dt-published" datetime="2014-12-05T09:09:00-05:00" itemprop="datePublished">Fri 05 December 2014
      </time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Cole Robinson</span>
      </span> • </a> Tags: <a href="https://blog2.wikichoon.com/tag/fedora.html">fedora </a><a href="https://blog2.wikichoon.com/tag/virt.html">virt </a>    </p>
  </header>

  <div class="post-content">
    <p>One of the big features we added in virt-manager 1.0 was <a href="http://blog.wikichoon.com/2014/03/snapshot-support-in-virt-manager.html">snapshot support</a>. As part of this change, we switched to using the QCOW2 disk image format for new VMs. We also enable the <a href="https://lists.gnu.org/archive/html/qemu-devel/2012-06/msg03827.html">QCOW2 lazy_refcounts</a> feature that improves performance of some snapshot operations.</p>
<p>However, not all versions of QEMU in the wild can handle lazy_refcounts, and will refuse to use the disk image, particularly RHEL6 QEMU. So by default, a disk image from a VM created with Fedora 20 virt-manager will not run on RHEL6 QEMU, throwing an error like:</p>
<blockquote>
<p>... uses a qcow2 feature which is not supported by this qemu version: QCOW version 3</p>
</blockquote>
<p>This has generated some <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1119929">user</a> <a href="https://lists.fedoraproject.org/pipermail/virt/2014-April/004040.html">confusion</a>.</p>
<p>The 'QCOW version 3' is a bit misleading here: while indeed using lazy_refcounts sets a bit in the QCOW2 file header calling it QCOW3, qemu-img and libvirt still call it QCOW2, but with a different 'compat' setting.</p>
<p>Kevin Wolf, one of the QEMU block maintainers, explains it in <a href="https://lists.fedoraproject.org/pipermail/virt/2014-April/004041.html">this mail</a>:</p>
<blockquote>
<p>qemu versions starting with 1.1 can use lazy_refcounts which require an incompatible on-disk format. Between version 1.1 and 1.6, they needed to be specified explicitly during image creation, like this:</p>
<p>qemu-img create -f qcow2 -o compat=1.1 test.qcow2 8G</p>
<p>Starting with qemu 1.7, compat=1.1 became the default, so that newly created images can't be read by older qemu versions by default. If you need to read them in older version, you now need to be explicit about using the old format:</p>
<p>qemu-img create -f qcow2 -o compat=0.10 test.qcow2 8G</p>
<p>With the same release, qemu 1.7, a new qemu-img subcommand was introduced that allows converting between both versions, so you can downgrade your existing v3 image to the format known by RHEL 6 like this</p>
<p>qemu-img amend -f qcow2 -o compat=0.10 test.qcow2</p>
</blockquote>
<p>As explained, qemu-img with QEMU 1.7+ also defaults to lazy_refcounts/compat=1.1, but also provides a 'qemu-img amend' tool to easily convert between the two formats.</p>
<p>Unfortunately that command is not available on Fedora 20 and older, however you can use the pre-existing 'qemu-img convert' command:</p>
<p><code>qemu-img convert -f qcow2 -O qcow2 -o compat=0.10 $ORIGPATH $NEWPATH</code></p>
<p>Beware though, converting between two qcow2 images will drop all internal snapshots in the new image, so only use that option if you don't need to preserve any snapshot data. 'qemu-img amend' [will]{.underline} preserve snapshot data.</p>
<p>(Unfortunately at this time virt-manager doesn't provide any way in the UI to _not_ use lazy_refcounts, but you could always use qemu-img/virsh to create a disk image outside of virt-manager, and select it when creating a new VM.)</p>
  </div>

</main>


<footer class="site-footer h-card">
  <div class="wrapper">
    <h2 class="footer-heading">Cole's dev log</h2>
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
            <li class="p-name">Cole Robinson </li><li><a class="u-email" href="mailto:">aintdiscole@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/crobinso"><svg class="svg-icon"><use xlink:href="https://blog2.wikichoon.com/theme/minima-social-icons.svg#github"></use></svg> <span class="username">crobinso</span></a></li><li><a href="https://www.twitter.com/aintdiscole"><svg class="svg-icon"><use xlink:href="https://blog2.wikichoon.com/theme/minima-social-icons.svg#twitter"></use></svg> <span class="username">aintdiscole</span></a></li><li><a href="https://www.linkedin.com/in/cole-robinson-484a9912"><svg class="svg-icon"><use xlink:href="https://blog2.wikichoon.com/theme/minima-social-icons.svg#linkedin"></use></svg> <span class="username">Cole Robinson</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3" align="center">
        <a href="https://blog2.wikichoon.com/feeds/all.atom.xml">RSS</a>
      </div>
    </div>

  </div>
</footer>
        </div><!-- container -->
    </body>
</html>