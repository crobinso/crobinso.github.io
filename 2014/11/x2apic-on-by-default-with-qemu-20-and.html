<!DOCTYPE html>
<html>
    <head>
        <title>x2apic on by default with qemu 2.0+, and some history - Cole's dev log</title>
        <meta charset="utf-8" />
        <link href="https://crobinso.github.io/theme/minima-main.css" rel="stylesheet" />
        <link href="https://crobinso.github.io/theme/coletheme.css" rel="stylesheet" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <link href="https://crobinso.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Cole's dev log Full Atom Feed" />
    </head>

    <body id="index" class="archive">
        <div class="wrapper">
            <header class="site-header" role="banner">
                <a class="site-title" href="https://crobinso.github.io">Cole's dev log</a>
                <nav class="site-nav">
                <div class="trigger">
                    <a class="page-link" href="https://crobinso.github.io">Home</a>
                    <a class="page-link" href="https://crobinso.github.io/archives.html">Archives</a>
                <!-- -->
                </div></nav>
             </header>
<main id="content" class="page-content">

  <header>
    <h2 class="post-title">x2apic on by default with qemu 2.0+, and some history</h2>
    <p class="post-meta">
      <time class="dt-published" datetime="2014-11-28T14:37:00-05:00" itemprop="datePublished">Fri 28 November 2014
      </time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Cole Robinson</span>
      </span> • </a> Tags: <a href="https://crobinso.github.io/tag/fedora.html">fedora </a><a href="https://crobinso.github.io/tag/virt.html">virt </a>    </p>
  </header>

  <div class="post-content">
    <p><a href="https://en.wikipedia.org/wiki/X2APIC">x2apic</a> is a performance and scalability feature available in many modern Intel CPUs. Though regardless of whether your host CPU supports it, KVM can unconditionally emulate it for x86 guests, giving an easy performance win with no downside. This feature has existed since 2009 and been a regular recommendation for <a href="http://www.linux-kvm.org/page/Tuning_KVM">tuning a KVM VM</a>.</p>
<p>As of qemu 2.0.0 x2apic is enabled automatically (more details at the end).
Priot to that, actually benefiting from x2apic required a tool like virt-manager to explicitly enable the flag, which has had a long bumpy road.</p>
<p>x2apic is exposed on the qemu command line as a CPU feature, like: <code>qemu -cpu $MODEL,+x2apic ...</code></p>
<p>And there isn't any way to specify a feature flag without specifying the CPU model. So enabling x2apic required hardcoding a CPU model where traditionally tools (and libvirt) deferred to qemu's default.</p>
<p>A Fedora 13 <a href="https://fedoraproject.org/wiki/Features/Virtx2apic">feature page</a> was created to track the change, and we <a href="http://pkgs.fedoraproject.org/cgit/python-virtinst.git/commit/?id=7a684cb65d69f2b116809456bed99ed32ca44080">enabled it in python-virtinst</a> for f13/rawhide. The implementation attempted to hardcode the CPU model name that libvirt detected for the host machine, which unfortunately has some problems as I explained in a <a href="http://blog.wikichoon.com/2014/03/virt-manager-improved-cpu-model-default.html">previous post</a>. This led to some <a href="https://bugzilla.redhat.com/show_bug.cgi?id=611584">issues</a> installing 64bit guests, and after trying to hack around it, I gave up and reverted the change.</p>
<p>(In retrospect, we likely could have made it work by just trying to duplicate the default CPU model logic that qemu uses, however that might have hit issues if the CPU default ever changed, like on RHEL for example.)</p>
<p>Later on virt-manager and virt-install gained UI for enabling x2apic, but a user had to know what they were doing and hunt it down.</p>
<p>As mentioned above, as of qemu 2.0.0 any x86 KVM VM will have x2apic automatically enabled, so there's no explicit need to opt in. From qemu.git:</p>
<div class="highlight"><pre><span></span>commit ef02ef5f4536dba090b12360a6c862ef0e57e3bc
Author: Eduardo Habkost &lt;ehabkost redhat.com&gt;
Date:   Wed Feb 19 11:58:12 2014 -0300

    target-i386: Enable x2apic by default on KVM
</pre></div>
  </div>

</main>


<footer class="site-footer h-card">
  <div class="wrapper">
    <h2 class="footer-heading">Cole's dev log</h2>
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
            <li class="p-name">Cole Robinson </li><li><a class="u-email" href="mailto:">aintdiscole@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/crobinso"><svg class="svg-icon"><use xlink:href="https://crobinso.github.io/theme/minima-social-icons.svg#github"></use></svg> <span class="username">crobinso</span></a></li><li><a href="https://www.twitter.com/aintdiscole"><svg class="svg-icon"><use xlink:href="https://crobinso.github.io/theme/minima-social-icons.svg#twitter"></use></svg> <span class="username">aintdiscole</span></a></li><li><a href="https://www.linkedin.com/in/cole-robinson-484a9912"><svg class="svg-icon"><use xlink:href="https://crobinso.github.io/theme/minima-social-icons.svg#linkedin"></use></svg> <span class="username">Cole Robinson</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3" align="center">
        <a href="https://crobinso.github.io/feeds/all.atom.xml">RSS</a>
      </div>
    </div>

  </div>
</footer>
        </div><!-- container -->
    </body>
</html>