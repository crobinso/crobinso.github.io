<!DOCTYPE html>
<html>
    <head>
        <title>UEFI support in virt-install and virt-manager - Cole's dev log</title>
        <meta charset="utf-8" />
        <link href="https://crobinso.github.io/theme/minima-main.css" rel="stylesheet" />
        <link href="https://crobinso.github.io/theme/coletheme.css" rel="stylesheet" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <link href="https://crobinso.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Cole's dev log Full Atom Feed" />
    </head>

    <body id="index" class="archive">
        <div class="wrapper">
            <header class="site-header" role="banner">
                <a class="site-title" href="https://crobinso.github.io">Cole's dev log</a>
                <nav class="site-nav">
                <div class="trigger">
                    <a class="page-link" href="https://crobinso.github.io">Home</a>
                    <a class="page-link" href="https://crobinso.github.io/archives.html">Archives</a>
                <!-- -->
                </div></nav>
             </header>
<main id="content" class="page-content">

  <header>
    <h2 class="post-title">UEFI support in virt-install and virt-manager</h2>
    <p class="post-meta">
      <time class="dt-published" datetime="2016-01-02T17:19:00-05:00" itemprop="datePublished">Sat 02 January 2016
      </time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Cole Robinson</span>
      </span> • </a> Tags: <a href="https://crobinso.github.io/tag/fedora.html">fedora </a><a href="https://crobinso.github.io/tag/virt.html">virt </a>    </p>
  </header>

  <div class="post-content">
    <p>One of the new features in <a href="http://blog.wikichoon.com/2015/05/virt-manager-120-released.html">virt-manager 1.2.0</a> (from back in May) is user friendly support for enabling UEFI.</p>
<p>First a bit about terminology: When UEFI is packaged up to run in an x86 VM, it's often called <strong>OVMF</strong>. When UEFI is packaged up to run in an AArch64 VM, it's often called <strong>AAVMF</strong>. But I'll just refer to all of it as UEFI.</p>
<p><br/></p>
<h3>Using UEFI with virt-install and virt-manager</h3>
<p>The first step to enable this for VMs is to install the binaries. UEFI still has some <a href="https://fedoraproject.org/wiki/Using_UEFI_with_QEMU#EDK2_Licensing_Issues">licensing issues</a> that make it incompatible with Fedora's policies, so the bits are hosted in an external repo. Details for installing the repo and UEFI bits are <a href="https://fedoraproject.org/wiki/Using_UEFI_with_QEMU#Firmware_installation">over here</a>.</p>
<p>Once the bits are installed (and you're on Fedora 22 or later), virt-manager and virt-install provide simple options to enable UEFI when creating VMs.</p>
<p><a href="https://marcin.juszkiewicz.com.pl/2015/04/17/running-vms-on-fedoraaarch64/">Marcin has a great post</a> with screenshots describing this for virt-manager (for aarch64, but the steps are identical for x86 VMs).</p>
<p>For virt-install it's as simple as doing: <code>sudo virt-install --boot uefi ...</code></p>
<p>virt-install will get the binary paths from libvirt and set everything up with the optimal config. If virt-install can't figure out the correct parameters, like if no UEFI binaries are installed, you'll see an error like: ERROR    Error: --boot uefi: Don't know how to setup UEFI for arch 'x86'</p>
<p>See 'virt-install --boot help' if you need to tweak the parameters individually.</p>
<p><br/></p>
<h3>Implementing support in applications</h3>
<p>Libvirt needs to know about UEFIto NVRAM config file mapping, so it can advertise it to tools like virt-manager/virt-install. Libvirt looks at a hardcoded list of known host paths to see if any firmware is installed, and if so, lists those paths in domain capabilities output (virsh domcapabilities). Libvirt in Fedora 22+ knows to look for the paths provided by the repo mentioned above, so just installing the firmware is sufficient to make libvirt advertise UEFI support.</p>
<p>The domain capabilities output only lists the firmware path and the associated variable store path. Notably lacking is any indication of what architecture the binaries are meant for. So tools need to determine this mapping themselves.</p>
<p>virt-manager/virt-install and libguestfs use a similar path matching heuristic. The <a href="https://github.com/libguestfs/libguestfs/blob/master/v2v/utils.ml#L89">libguestfs code</a> is a good reference:</p>
<div class="highlight"><pre><span></span><span class="k">match</span> <span class="n">guest_arch</span> <span class="k">with</span>
<span class="o">|</span> <span class="s2">&quot;i386&quot;</span> <span class="o">|</span> <span class="s2">&quot;i486&quot;</span> <span class="o">|</span> <span class="s2">&quot;i586&quot;</span> <span class="o">|</span> <span class="s2">&quot;i686&quot;</span> <span class="o">-&gt;</span>
   <span class="o">[</span> <span class="s2">&quot;/usr/share/edk2.git/ovmf-ia32/OVMF_CODE-pure-efi.fd&quot;</span><span class="o">,</span>
     <span class="s2">&quot;/usr/share/edk2.git/ovmf-ia32/OVMF_VARS-pure-efi.fd&quot;</span> <span class="o">]</span>
<span class="o">|</span> <span class="s2">&quot;x86_64&quot;</span> <span class="o">-&gt;</span>
   <span class="o">[</span> <span class="s2">&quot;/usr/share/OVMF/OVMF_CODE.fd&quot;</span><span class="o">,</span>
     <span class="s2">&quot;/usr/share/OVMF/OVMF_VARS.fd&quot;</span><span class="o">;</span>
     <span class="s2">&quot;/usr/share/edk2.git/ovmf-x64/OVMF_CODE-pure-efi.fd&quot;</span><span class="o">,</span>
     <span class="s2">&quot;/usr/share/edk2.git/ovmf-x64/OVMF_VARS-pure-efi.fd&quot;</span> <span class="o">]</span>
<span class="o">|</span> <span class="s2">&quot;aarch64&quot;</span> <span class="o">-&gt;</span>
   <span class="o">[</span> <span class="s2">&quot;/usr/share/AAVMF/AAVMF_CODE.fd&quot;</span><span class="o">,</span>
     <span class="s2">&quot;/usr/share/AAVMF/AAVMF_VARS.fd&quot;</span><span class="o">;</span>
     <span class="s2">&quot;/usr/share/edk2.git/aarch64/QEMU_EFI-pflash.raw&quot;</span><span class="o">,</span>
     <span class="s2">&quot;/usr/share/edk2.git/aarch64/vars-template-pflash.raw&quot;</span> <span class="o">]</span>
<span class="o">|</span> <span class="n">arch</span> <span class="o">-&gt;</span>
   <span class="n">error</span> <span class="o">(</span><span class="n">f_</span><span class="s2">&quot;don&#39;t know how to convert UEFI guests for architecture %s&quot;</span><span class="o">)</span>
         <span class="n">guest_arch</span> <span class="k">in</span>
</pre></div>


<p>Having to track this in every app is quite crappy, but it's the only good solution at the moment. Hopefully long term libvirt <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1295146">will grow some solution</a> that makes this easier for applications.</p>
  </div>

</main>


<footer class="site-footer h-card">
  <div class="wrapper">
    <h2 class="footer-heading">Cole's dev log</h2>
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
            <li class="p-name">Cole Robinson </li><li><a class="u-email" href="mailto:">aintdiscole@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/crobinso"><svg class="svg-icon"><use xlink:href="https://crobinso.github.io/theme/minima-social-icons.svg#github"></use></svg> <span class="username">crobinso</span></a></li><li><a href="https://www.twitter.com/aintdiscole"><svg class="svg-icon"><use xlink:href="https://crobinso.github.io/theme/minima-social-icons.svg#twitter"></use></svg> <span class="username">aintdiscole</span></a></li><li><a href="https://www.linkedin.com/in/cole-robinson-484a9912"><svg class="svg-icon"><use xlink:href="https://crobinso.github.io/theme/minima-social-icons.svg#linkedin"></use></svg> <span class="username">Cole Robinson</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3" align="center">
        <a href="https://crobinso.github.io/feeds/all.atom.xml">RSS</a>
      </div>
    </div>

  </div>
</footer>
        </div><!-- container -->
    </body>
</html>