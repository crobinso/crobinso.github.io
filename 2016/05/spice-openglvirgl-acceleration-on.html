<!DOCTYPE html>
<html>
    <head>
        <title>spice OpenGL/virgl acceleration on Fedora 24 - Cole's dev log</title>
        <meta charset="utf-8" />
        <link href="https://crobinso.github.io/theme/minima-main.css" rel="stylesheet" />
        <link href="https://crobinso.github.io/theme/coletheme.css" rel="stylesheet" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <link href="https://crobinso.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Cole's dev log Full Atom Feed" />
    </head>

    <body id="index" class="archive">
        <div class="wrapper">
            <header class="site-header" role="banner">
                <a class="site-title" href="https://crobinso.github.io">Cole's dev log</a>
                <nav class="site-nav">
                <div class="trigger">
                    <a class="page-link" href="https://crobinso.github.io">Home</a>
                    <a class="page-link" href="https://crobinso.github.io/archives.html">Archives</a>
                <!-- -->
                </div></nav>
             </header>
<main id="content" class="page-content">

  <header>
    <h2 class="post-title">spice OpenGL/virgl acceleration on Fedora 24</h2>
    <p class="post-meta">
      <time class="dt-published" datetime="2016-05-22T10:56:00-04:00" itemprop="datePublished">Sun 22 May 2016
      </time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Cole Robinson</span>
      </span> • </a> Tags: <a href="https://crobinso.github.io/tag/fedora.html">fedora </a><a href="https://crobinso.github.io/tag/virt.html">virt </a>    </p>
  </header>

  <div class="post-content">
    <p>New in Fedora 24 virt is 3D accelerated SPICE graphics, via <a href="https://virgil3d.github.io/">Virgl</a>. This is kinda-sorta OpenGL passthrough from the VM up to the host machine. Much of the initial support has been around since qemu 2.5, but it's more generally accessible now that SPICE is in the mix, since that's the default display type used by virt-manager and gnome-boxes.</p>
<p>I'll explain below how you can test things on Fedora 24, but first let's cover the hurdles and caveats. This is far from being something that can be turned on by default and there's still serious integration issues to iron out. All of this is regarding usage with libvirt tools.</p>
<h3>Caveats and known issues</h3>
<ul>
<li>This doesn't work with qemu:///system yet, which is what <a href="http://blog.wikichoon.com/2016/01/qemusystem-vs-qemusession.html">virt-manager uses by default</a>. Permissions and <a href="http://www.redhat.com/archives/libvir-list/2016-May/msg01435.html">cgroup access</a> are problematic at the moment. qemu:///session (the gnome-boxes default) is saved from some of these issues, but it's still affected by...</li>
<li><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1337333">svirt/selinux issues</a>. We haven't come up with a plan here yet.</li>
<li>When enabled, your VM can't be migrated or saved (migrate to disk), either directly or as part of taking a VM snapshot</li>
<li>This only works if connecting to a VM on your local machine. And once enabled, the VM isn't accessible remotely whatsoever</li>
<li>virt-manager has some weird rendering behavior that requires <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1337721">resizing the window first before you see any display output</a>. It's fixed upstream, but no fedora build yet. virt-viewer works fine</li>
<li>virt-manager has some <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1337721">weird behavior if trying to run two GL enabled VMs at once</a>. Patches have been posted upstream for spice-gtk</li>
</ul>
<p>Because of these issues, we haven't exposed this as a UI knob in any of the tools yet, to save us some redundant bug reports for the above issues from users who are just clicking a cool sounding check box :) Instead you'll need to explicitly opt in via the command line.</p>
<h3>Testing it out</h3>
<p>You'll need the following packages (or later) to test this:</p>
<ul>
<li>qemu-2.6.0-2.fc24</li>
<li>libvirt-1.3.3.1-2.fc24</li>
<li>virt-manager-1.3.2-4.20160520git2204de62d9.fc24</li>
<li>At least F24 beta on the host</li>
<li>Fedore 24 beta in the guest. Anything earlier is not going to actually enable the 3D acceleration. I have no idea about the state of other distributions. And to make it abundantly clear this is <strong>linux only</strong> and likely will be for a long time at least, I don't know if Windows driver support is even on the radar.</li>
</ul>
<p>Once you install a Fedora 24 VM through the standard methods, you can enable spice GL for your VM with these two commands:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> virt-xml --connect <span class="nv">$URI</span> <span class="nv">$VM_NAME</span> --confirm --edit --video <span class="nv">clearxml</span><span class="o">=</span>yes,model<span class="o">=</span>virtio,accel3d<span class="o">=</span>yes
<span class="gp">$</span> virt-xml --connect <span class="nv">$URI</span> <span class="nv">$VM_NAME</span> --confirm --edit --graphics <span class="nv">clearxml</span><span class="o">=</span>yes,type<span class="o">=</span>spice,gl<span class="o">=</span>on,listen<span class="o">=</span>none
</pre></div>


<p>The first command will switch the graphics device to 'virtio' and enable the 3D acceleration setting. The second command will set up spice to listen locally only, and enable GL. Make sure to fully poweroff the VM afterwards for the settings to take effect. If you want to make the changes manually with '<a href="http://wiki.libvirt.org/page/FAQ#Where_are_VM_config_files_stored.3F_How_do_I_edit_a_VM.27s_XML_config.3F">virsh edit</a>', the XML specifics are described in the <a href="https://cgit.freedesktop.org/spice/spice/commit/?id=782c7508e28fdeee786cdcebffd22f772d7f09ec">spice GL documentation</a>.</p>
<p>Once your VM has started up, you can verify that everything is working correctly by checking <code>glxinfo</code> output in the VM, 'virgl' should appear in the renderer string:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> glxinfo <span class="p">|</span> grep virgl
<span class="go">    Device: virgl (0x1010)</span>
<span class="go">OpenGL renderer string: Gallium 0.4 on virgl</span>
</pre></div>


<p>And of course the more fun test of giving supertuxkart a spin :)</p>
<p>Credit to Dave Airlie, Gerd Hoffman, and Marc-André Lureau for all the great work that got us to this point!</p>
  </div>

</main>


<footer class="site-footer h-card">
  <div class="wrapper">
    <h2 class="footer-heading">Cole's dev log</h2>
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
            <li class="p-name">Cole Robinson </li><li><a class="u-email" href="mailto:">aintdiscole@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/crobinso"><svg class="svg-icon"><use xlink:href="https://crobinso.github.io/theme/minima-social-icons.svg#github"></use></svg> <span class="username">crobinso</span></a></li><li><a href="https://www.twitter.com/aintdiscole"><svg class="svg-icon"><use xlink:href="https://crobinso.github.io/theme/minima-social-icons.svg#twitter"></use></svg> <span class="username">aintdiscole</span></a></li><li><a href="https://www.linkedin.com/in/cole-robinson-484a9912"><svg class="svg-icon"><use xlink:href="https://crobinso.github.io/theme/minima-social-icons.svg#linkedin"></use></svg> <span class="username">Cole Robinson</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3" align="center">
        <a href="https://crobinso.github.io/feeds/all.atom.xml">RSS</a>
      </div>
    </div>

  </div>
</footer>
        </div><!-- container -->
    </body>
</html>